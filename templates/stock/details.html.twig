{% extends 'base.html.twig' %}

{% block title %}BSX - Dashboard <div class="search_wrapper" style="display:inline;"><input type="text" placeholder="search stocks" id="stocksearch" /><div class="results"></div></div>{% endblock %}

{% block body %}
    {% set have_alive_options = false %}
    {% set shares_owned = 0 %}
    {% set stock_average = 0 %}

    {% for buy in stock.shareBuys %}
        {% if buy.sold < buy.amount %}
            {% set remaining = buy.amount - buy.sold %}
            {% set shares_owned = shares_owned + remaining %}
            {% set buy_average = remaining * buy.price %}
            {% set stock_average = stock_average + buy_average %}
        {% endif %}
    {% endfor %}
    
    {% set shares_owned = 0 %}
    {% set stock_average = 0 %}
    {% set stock_money_total = 0 %}
    {% set stock_earned = stock.earned %}
    {% set stock_current = stock.company.currentPrice %}
    {% set stock_breakeven = 0 %}
    {% set stock_pl = 0 %}
    {% set stock_buy_cost_total = 0 %}
    {% set buys = 0 %}
    {% set sells = 0 %}
    {% set d_bought = "" %}
    {% set d_sold = "" %}
    {% set buy_average = 0 %}
    {% set dividend_total_payments = 0 %}
    {% set dividend_total = 0 %}
    {% set dividend_average = 0 %}
    {% set dividend_latest = 0 %}

    {% set today = "now"|date('d-m-Y') %}
    {% set lastBuyDate = today %}
    {% set breakeven_fee = false %}


    {% for buy in stock.shareBuys %}
        {% set d_bought = buy.date %}
        {% if stock.company.noFee or buy.noFee %}
            {% set stock_buy_cost_total = stock_buy_cost_total + (buy.amount * buy.price) %}
        {% else %}
            {% set breakeven_fee = true %}
            {% set stock_buy_cost_total = stock_buy_cost_total + (buy.amount * buy.price) + 9.95 %}
        {% endif %}
        {% if buy.sold < buy.amount %}
            {% set remaining = buy.amount - buy.sold %}
            {% set buys = buys + 1 %}
            {% set shares_owned = shares_owned + remaining %}
            {% set buy_average = remaining * buy.price %}
            {% set stock_average = stock_average + buy_average %}
            {% set stock_money_total = stock_money_total + buy_average %}
            {% set lastBuyDate = buy.date|date('d-m-Y') %}
        {% endif %}

    {% endfor %}

    {# {{ stock_buy_cost_total }} | {{ shares_owned }} | {{ buy_average }} | {{ stock_average }} #}


    {% if shares_owned > 0 %}
        {% set stock_average = stock_average / shares_owned %}
        {% if stock.company.noFee or breakeven_fee == false %}
            {% set fee = 0 %}
        {% else %}
            {% set fee = ((buys * 9.95) + 9.95) / shares_owned %}
        {% endif %}
        {% set stock_breakeven = fee + stock_average %}
        {% set diff = stock_current - stock_breakeven %}
        {% set stock_pl = diff * shares_owned %}
    {% endif %}

    {% set total_sold = 0 %}
    {% for sell in stock.shareSells %}
        {% set sells = sells + 1 %}
        {% if stock.company.noFee %}
            {% set total_sold = total_sold + (sell.amount * sell.price) %}
            {% set stock_earned = stock_earned + (sell.amount * sell.price) %}
        {% else %}
            {% set total_sold = total_sold + (sell.amount * sell.price) - 9.95 %}
            {% set stock_earned = stock_earned + (sell.amount * sell.price) - 9.95 %}
        {% endif %}
        {% set d_sold = sell.date %}
    {% endfor %}


    {% for dividend_payment in stock.dividends %}
        {% set dividend_total_payments = dividend_total_payments + 1 %}
        {% set dividend_total = dividend_total + dividend_payment.amount %}
        {% set dividend_latest = dividend_payment.amount %}
        {% set dividend_average = dividend_total / dividend_total_payments %}
    {% endfor %}
    
    

    {% set stock_earned = stock_earned + dividend_total - stock_buy_cost_total %}
    {% set cc_total = 0 %}
    {% set breakeven_cc = 0 %}
    {% for cc in stock.coveredCalls %}
        {% set cc_total = cc_total + (((cc.price * cc.contracts) * 100) - 9.95 - (1.25 * cc.contracts)) - cc.buyoutPrice %}
        {% set stock_earned = stock_earned + (((cc.price * cc.contracts) * 100) - 9.95 - (1.25 * cc.contracts)) %}
        {% if shares_owned > 0 %}
            {% set breakeven_cc = stock_breakeven - (cc_total / shares_owned) %}
        {% endif %}
    {% endfor %}

    {% set buyDateDifference = date(today).diff(date(lastBuyDate))%}
    {% set daysSinceLastBuy = buyDateDifference.days %}

    {% set options_total = 0 %}
    {% set options_cost = 0 %}
    {% set options_total_sell_value = 0 %}
    {% set options_rollover = 0 %}
    {% for option in stock.options %}
        {% if option.expiry|date_modify("16:30")|date('U', "America/New_York") > "now"|date('U', "America/New_York") %}
            {% set have_alive_options = true %}
        {% endif %}
        {% set options_rollover = 0 %}
        {% for rollover in option.optionRollovers %}
            {% set options_rollover = options_rollover + ((((rollover.oldPrice - rollover.newPrice) * rollover.contracts) * 100)) %}
            {% set options_cost = options_cost + (9.95 + (2.50 * rollover.contracts)) %}
        {% endfor %}
        {% set options_cost = options_cost + (option.totalContracts * (option.average * 100)) + (9.95 * option.buys) + (1.25 * option.totalContracts) %}
        {% set options_total_sell_value = options_total_sell_value + (option.totalContractsSold * (option.sellPrice * 100)) - (option.sells * 9.95) - (1.25 * option.totalContractsSold) + options_rollover %}
        {% set options_total = options_total_sell_value - options_cost %}
    {% endfor %}

    <div class="wide_column relative">
        <ul id="searchresults" style="display:none;" class="absolute z-10 mt-1 max-h-56 w-full overflow-auto rounded-md bg-white py-1 text-base shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none sm:text-sm" tabindex="-1" role="listbox" aria-labelledby="listbox-label" aria-activedescendant="listbox-option-3">
            <!--
              Select option, manage highlight styles based on mouseenter/mouseleave and keyboard navigation.

              Highlighted: "bg-indigo-600 text-white", Not Highlighted: "text-gray-900"
            -->
            {% for stock in stocks %}
                <li data-name="{{ stock.company.name }}" data-ticker="{{ stock.company.ticker }}" data-sector="{{ stock.company.sector.name }}" class="relative cursor-default select-none py-2 pl-3 pr-9 text-gray-900 hover:bg-gray-50 hover:cursor-pointer" id="listbox-option-0" role="option">
                    <a class="flex items-center" href="/stocks/details/{{ stock.id }}">
                        <img src="/assets/images/company_logos/{{ stock.company.ticker }}.jpg" alt="" class="h-5 w-5 flex-shrink-0 rounded-full">
                        <!-- Selected: "font-semibold", Not Selected: "font-normal" -->
                        <span class="ml-3 block truncate font-normal">({{ stock.company.ticker }}) {{ stock.company.name }}</span>
                    </a>
                </li>
            {% endfor %}

            <!-- More items... -->
        </ul>
    </div>

    <div>
        <div class="px-4 py-6 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-0">
            <div class="border-8 border-black rounded-full w-80 h-80" style="background-color:#{{ stock.company.bgColor }}; background-image:url('/assets/images/company_logos/{{ stock.company.ticker }}.jpg'); background-position: center center; background-repeat: no-repeat; background-size:cover;"></div>
            <div class="sm:col-span-2">
                <div class="text-6xl"><span class="text-9xl" style="font-size: 190px;">{{ stock.company.ticker }}</span> <span>${{ stock.company.currentPrice|number_format(2) }}</span></div>
                <div>

                </div>
            </div>

        </div>
        <div class="px-4 sm:px-0">
            <h3 class="text-base font-semibold leading-7 text-gray-900">Stock Information</h3>
            <p class="mt-1 max-w-2xl text-sm leading-6 text-gray-500">Personal details and application.</p>
        </div>
        <div class="mt-6 border-t border-gray-100">
            <dl class="divide-y divide-gray-100">

                {# Company Details #}
                <div class="px-4 py-6 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-0">
                    <dt class="text-sm font-medium leading-6 text-gray-900">Company Name</dt>
                    <dd class="mt-1 text-sm leading-6 text-gray-700 sm:col-span-2 sm:mt-0">{{ stock.company.name }}</dd>
                </div>

                <div class="px-4 py-6 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-0">
                    <dt class="text-sm font-medium leading-6 text-gray-900">Sector</dt>
                    <dd class="mt-1 text-sm leading-6 text-gray-700 sm:col-span-2 sm:mt-0">{{ stock.company.sector.name }}</dd>
                </div>

                {# Stock Details #}
                <div class="px-4 py-6 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-0">
                    <dt class="text-sm font-medium leading-6 text-gray-900">Stock Type</dt>
                    <dd class="mt-1 text-sm leading-6 text-gray-700 sm:col-span-1 sm:mt-0">{% if stock.company.country == "USD" %}<img src="/assets/images/flag_us.png" alt=""> United States (NYSE){% else %}<img src="/assets/images/flag_can.png" alt="">Canada (TSX){% endif %}</dd>
                    <dd class="mt-1 text-sm leading-6 text-gray-700 sm:col-span-1 sm:mt-0"><img src="/assets/images/{{ stock.company.type }}_chip.png">{{ stock.company.type }} CHIP</dd>
                </div>

                {# Amount Owned #}
                <div class="px-4 py-6 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-0">
                    <dt class="text-sm font-medium leading-6 text-gray-900">Shares Owned</dt>
                    <dd class="mt-1 text-sm leading-6 text-gray-700 sm:col-span-2 sm:mt-0">{{ shares_owned }}</dd>
                </div>

                {# Performance #}
                <div class="px-4 py-6 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-0">
                    <dt class="text-sm font-medium leading-6 text-gray-900">Performance</dt>
                    <dd class="mt-1 text-sm leading-6 text-gray-700 sm:col-span-2 sm:mt-0">
                        {% if shares_owned > 0 %}
                        <table style="width:100%;">
                            <tr>
                                <td>
                                    <h2>Week</h2>
                                    {% set percent_change = ((stock_current / stock.company.priceWeek) * 100) - 100 %}
                                    <span class="text-4xl" style="color:{% if percent_change > 0 %}green{% elseif percent_change < 0 %}red{% else %}black{% endif %};">{{ percent_change|number_format(2) }}%</span></span><br />Stock Price: ${{ stock.company.priceWeek|number_format(2) }}
                                </td>

                                <td>
                                    <h2>Month</h2>
                                    {% set percent_change = ((stock_current / stock.company.priceMonth) * 100) - 100 %}
                                    <span class="text-4xl" style="color:{% if percent_change > 0 %}green{% elseif percent_change < 0 %}red{% else %}black{% endif %};">{{ percent_change|number_format(2) }}%</span><br />Stock Price: ${{ stock.company.priceMonth|number_format(2) }}
                                </td>

                                <td>
                                    <h2>Year</h2>
                                    {% set percent_change = ((stock_current / stock.company.priceYear) * 100) - 100 %}
                                    <span class="text-4xl" style="color:{% if percent_change > 0 %}green{% elseif percent_change < 0 %}red{% else %}black{% endif %};">{{ percent_change|number_format(2) }}%</span><br />Stock Price: ${{ stock.company.priceYear|number_format(2) }}
                                </td>
                            </tr>
                        </table>
                        {% else %}
                            No Performance Metrics for Stock with No Shares.
                        {% endif %}
                    </dd>
                </div>

                {# Key Dates #}
                <div class="px-4 py-6 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-0">
                    <dt class="text-sm font-medium leading-6 text-gray-900">Key Dates</dt>
                    <dd class="mt-1 text-sm leading-6 text-gray-700 sm:col-span-2 sm:mt-0">
                        <div class="relative overflow-x-auto">
                            <table class="w-full text-sm text-left rtl:text-right text-gray-500 dark:text-gray-400">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                                <tr>
                                    <th scope="col" class="px-6 py-3">Last Bought</th>
                                    <th scope="col" class="px-6 py-3">Last Sold</th>
                                    <th scope="col" class="px-6 py-3">Days Owned</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700">
                                    <td class="px-6 py-4">{% if d_bought != "" %}{{ d_bought|date("m/d/Y") }}{% endif %}</td>
                                    <td class="px-6 py-4">{% if d_sold != "" %}{{ d_sold|date("m/d/Y") }}{% else %}Never Sold{% endif %}</td>
                                    <td class="px-6 py-4">{{ daysSinceLastBuy }}</td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </dd>
                </div>

                {# Earned #}
                <div class="px-4 py-6 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-0">
                    <dt class="text-sm font-medium leading-6 text-gray-900">Earned</dt>
                    <dd class="mt-1 text-sm leading-6 text-gray-700 sm:col-span-2 sm:mt-0">
                        {% set cc_debt = 0 %}
                        {% set cc_earned = 0 %}
                        {% set options_debt = 0 %}
                        {% set options_earned = 0 %}

                        {% if cc_total < 0 %}
                            {% set cc_debt = cc_total * -1 %}
                        {% elseif cc_total > 0  %}
                            {% set cc_earned = cc_total %}
                        {% endif %}

                        {% set total_debt = stock_buy_cost_total + cc_debt + options_cost %}
                        {% if cc_earned >= 0 %}
                            {% set total_returned = total_sold + dividend_total + cc_earned + options_total_sell_value %}
                        {% else %}
                            {% set total_returned = total_sold + dividend_total + options_total_sell_value %}
                        {% endif %}

                        {% set share_value = (shares_owned * stock.company.currentPrice) - 9.95 %}

                        {% set status_total_return = total_returned %}
                        {% set status_total_return_with_current_share_value = total_returned + share_value %}

                        {% set remaining_till_gold = (total_returned - total_debt) %}
                        {% set remaining_till_gold_abs = remaining_till_gold|abs  %}

                        {% if total_debt == 0 %}{% set total_debt = 0.01 %}{% endif %}
                        {% set percent_increase = (((status_total_return - total_debt) / total_debt) * 100) %}
                        {% set percent_increase_with_current_share_value = (((status_total_return_with_current_share_value - total_debt) / total_debt) * 100) %}

                        <div id="status_debug" style="display:none;">
                            Bought: ${{ stock_buy_cost_total|number_format(2) }}<br />
                            Sold: ${{ total_sold|number_format(2) }}<br />
                            Dividends: ${{ dividend_total|number_format(2) }}<br />
                            Covered Call: ${{ cc_total|number_format(2) }}<br />
                            Naked Options: ${{ options_total|number_format(2) }}<br />
                            -----------------<br />
                            Total Debt: ${{ total_debt|number_format(2)  }}<br />
                            Share Value: {{ shares_owned }} * {{ stock.company.currentPrice }} = ${{ share_value|number_format(2) }}<br />
                            Total Sold: ${{ total_returned|number_format(2)  }}<br />

                            {% if remaining_till_gold < 0 %}
                                {% if shares_owned > 0 %}
                                    Remaining Till Debt Free: ${{ remaining_till_gold|number_format(2) }} | {{ shares_owned }} Shares / {{ remaining_till_gold|abs|number_format(2) }} = ${{ (remaining_till_gold|abs/shares_owned)|number_format(2) }}<br />
                                {% else %}
                                    Remaining Till Debt Free: ${{ remaining_till_gold|number_format(2) }}
                                {% endif %}
                                Percent Increase: {{ percent_increase|number_format(2) }}%;<br />
                            {% else %}
                                Debt Free:True ({{ percent_increase|number_format(2) }}% Return)<br />
                            {% endif %}

                            {% if shares_owned > 0 %}
                                Percent Increase with Current Share Value: {{ percent_increase_with_current_share_value|number_format(2) }}%;<br />
                            {% endif %}
                            <br />
                            <small>Earned Calculation: sold (${{ total_sold|number_format(2) }}) - bought (${{ stock_buy_cost_total|number_format(2)  }}) + dividend (${{ dividend_total|number_format(2)  }}) + covered_call (${{ cc_total|number_format(2)  }}) + options $({{ options_total|number_format(2)  }})</small><br />
                        </div>
                        <div class="relative flex items-center justify-center h-[60px] w-full">
                            <button id="status_debug_btn" onclick="show_status_legend();" class="absolute left-4 top-1/2 -translate-y-1/2 px-3 py-1 bg-blue-500 text-white text-xs rounded">Show Earned Calculation</button>
                            {% set new_total = (total_sold - stock_buy_cost_total + dividend_total + cc_total + options_total) %}
                            <span class="text-6xl font-medium text-slate-500">${{ new_total|number_format(2) }}</span>
                            <span class="absolute right-4 top-1/2 -translate-y-1/2 text-2xl {% if percent_increase < 0 %}text-red-600{% elseif percent_increase|number_format(2) == 0.00 %}text-black{% else %}text-green-600{% endif %}">{{ percent_increase|number_format(2) }}%</span>
                        </div>
                        <script>
                            let status_debug_hidden = true;
                            function show_status_legend(){
                                if (!status_debug_hidden){
                                    document.getElementById("status_debug_btn").innerHTML = "Show Debug";
                                    document.getElementById('status_debug').style.display = 'none';
                                    status_debug_hidden = true;
                                } else {
                                    document.getElementById("status_debug_btn").innerHTML = "Hide Debug";
                                    document.getElementById('status_debug').style.display = 'block';
                                    status_debug_hidden = false;
                                }
                            }
                        </script>
                    </dd>
                </div>

                {# Breakeven Price #}
                {% set breakeven_all = 0.00 %}
                {% if new_total < 0 %}
                    {% set sell_fee = 9.95 %}
                    {% if stock.company.noFee %}{% set sell_fee = 0 %}{% endif %}
                    {% if shares_owned > 0 %}
                        {% set breakeven_all = ((new_total|abs) + sell_fee) / shares_owned %}
                    {% else %}
                        {% set breakeven_all = ((new_total|abs) + sell_fee) %}
                    {% endif %}
                {% endif %}
                <div class="px-4 py-6 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-0">
                    <dt class="text-sm font-medium leading-6 text-gray-900">Break Even Prices</dt>
                    <dd class="mt-1 text-sm leading-6 text-gray-700 sm:col-span-2 sm:mt-0">
                        {% if shares_owned <= 0 and have_alive_options == false %}
                            No current positions to breakeven with. <small>(No shares or active options).</small>
                        {% else %}
                            <div class="flex flex-col">
                            <div class="-m-1.5 overflow-x-auto">
                                <div class="p-1.5 min-w-full inline-block align-middle">
                                    <div class="border rounded-lg shadow overflow-hidden dark:border-neutral-700 dark:shadow-gray-900">
                                        <table class="min-w-full divide-y divide-gray-200 dark:divide-neutral-700">
                                            <thead>
                                            <tr class="divide-x divide-gray-200 dark:divide-neutral-700">
                                                <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase dark:text-neutral-500">Shares Only</th>
                                                <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase dark:text-neutral-500">with Covered Calls</th>
                                                <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase dark:text-neutral-500">with Everything<br /><small>(Covered Calls, Naked Options, Dividends)</small></th>
                                            </tr>
                                            </thead>
                                            <tbody class="divide-y divide-gray-200 dark:divide-neutral-700">
                                            <tr>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-center font-medium text-gray-800 dark:text-neutral-200"><span class="text-3xl">${{ stock_breakeven|number_format(2) }}</span></td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-center font-medium text-gray-800 dark:text-neutral-200"><span class="text-3xl">${{ breakeven_cc|number_format(2) }}</span></td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-center font-medium text-gray-800 dark:text-neutral-200"><span class="text-3xl">${{ breakeven_all|number_format(2) }}</span></td>
                                            </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </dd>
                </div>

                {# Company Status #}
                <div class="px-4 py-6 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-0">
                    <dt class="text-sm font-medium leading-6 text-gray-900">Company Status</dt>
                    <dd class="mt-1 text-sm leading-6 text-gray-700 sm:col-span-2 sm:mt-0">
                        <div class="label mb-3">
                        {% if total_debt >= status_total_return %}
                            <div class="bg-rose-700 inline-block w-5 h-5 rounded-3xl border border-solid border-black"></div><span class="inline-block ml-2 align-top relative bottom-0.5">UNDERWATER</span>
                            {% set range_stage = 1 %}
                            {% set percent_plus = 0 %}
                            {% set block_percent = (100 + percent_increase) %}
                        {% else %}
                            {% if percent_increase < 100 %}
                                <div class="bg-green-700 inline-block w-5 h-5 rounded-3xl border border-solid border-black"></div><span class="inline-block ml-2 align-top relative bottom-0.5">PROFITABLE</span>
                                {% set range_stage = 2 %}
                                {% set percent_plus = 12 %}
                                {% set block_percent = percent_increase %}
                            {% elseif percent_increase < 200 %}
                                <div class="bg-yellow-800 inline-block w-5 h-5 rounded-3xl border border-solid border-black"></div><span class="inline-block ml-2 align-top relative bottom-0.5">GOLD LEVEL 1 (+100%)</span>
                                {% set range_stage = 3 %}
                                {% set percent_plus = 24 %}
                                {% set block_percent = percent_increase - 100 %}
                            {% elseif percent_increase < 300 %}
                                <div class="bg-yellow-700 inline-block w-5 h-5 rounded-3xl border border-solid border-black"></div><span class="inline-block ml-2 align-top relative bottom-0.5">GOLD LEVEL 2 (+200%)</span>
                                {% set range_stage = 4 %}
                                {% set percent_plus = 36 %}
                                {% set block_percent = percent_increase - 200 %}
                            {% elseif percent_increase < 400 %}
                                <div class="bg-yellow-600 inline-block w-5 h-5 rounded-3xl border border-solid border-black"></div><span class="inline-block ml-2 align-top relative bottom-0.5">GOLD LEVEL 3 (+300%)</span>
                                {% set range_stage = 5 %}
                                {% set percent_plus = 48 %}
                                {% set block_percent = percent_increase - 300 %}
                            {% elseif percent_increase < 500 %}
                                <div class="bg-yellow-500 inline-block w-5 h-5 rounded-3xl border border-solid border-black"></div><span class="inline-block ml-2 align-top relative bottom-0.5">GOLD LEVEL 4 (+400%)</span>
                                {% set range_stage = 6 %}
                                {% set percent_plus = 60 %}
                                {% set block_percent = percent_increase - 400 %}
                            {% else %}
                                {% set range_stage = 6 %}
                                {% set percent_plus = 59 %}
                                {% set block_percent = 100 %}
                                <div class="bg-yellow-400 inline-block w-5 h-5 rounded-3xl border border-solid border-black"></div><span class="inline-block ml-2 align-top relative bottom-0.5">GOLD LEVEL 5 (+500%)</span>
                            {% endif %}
                        {% endif %}
                        </div>

                        {% set marker_percent = percent_plus + (block_percent * 0.4) %}

                        {% set middle = "[" ~ percent_increase|number_format(2) ~ "%]"  %}

                        {% set marker_nudge = 11 %}

                        <style>
                            .marker {
                                position: absolute;
                                top: -10px;
                                width: 0px;
                                height: 0px;
                                border-style: solid;
                                border-width: 0 10px 15px 10px;
                                border-color: transparent transparent #000000 transparent;
                                transform: rotate(180deg);
                                z-index: 10;
                            }

                            .stage {
                                position: relative;
                                display: inline-block;
                                width: 20%;
                                height: 100%;
                                padding-right: 5px;
                                border-right: solid 2px black;
                                text-align: right;
                                z-index: 5;

                                color: white;
                                text-shadow: rgba(0,0,0,1) 1px 1px 2px;

                                .left{
                                    position: absolute;
                                    left: 5px;
                                    top: 50%;
                                    transform: translateY(-50%);
                                }

                                .middle{
                                    position: absolute;
                                    left: 50%;
                                    top: 50%;
                                    transform: translate(-50%, -50%);
                                    font-size: 10px;
                                }

                                .right{
                                    position: absolute;
                                    right: 5px;
                                    top: 50%;
                                    transform: translateY(-50%);
                                }
                            }

                            .stage:first-of-type{
                                border-radius: 50px 0 0 50px;
                            }

                            .stage:last-of-type{
                                border-right: 0;
                                border-radius: 0 50px 50px 0;
                            }
                        </style>

                        <div class="relative" style="background:white; border:solid 1px black; border-radius:50px; height:30px;">
                            <div class="marker" style="left:calc({{ marker_percent|number_format(2) }}% - {{ marker_nudge }}px)"></div>
                            <div class="stage bg-rose-700" style="{% if range_stage == 1 %}width:40%;{% else %}width:12%;{% endif %} left:0; border-radius: 50px 0 0 50px;">{% if range_stage == 1 %}<span class="left">-100%</span><span class="middle"> Underwater: {{ middle }} </span>{% endif %}<span class="right">0%</span></div><!--
                            --><div class="stage bg-green-600" style="{% if range_stage == 2 %}width:40%;{% else %}width:12%;{% endif %}">{% if range_stage == 2 %}<span class="left">0%</span><span class="middle"> Profitable: {{ middle }} </span>{% endif %}<span class="right">100%</span></div><!--
                            --><div class="stage bg-yellow-700" style="{% if range_stage == 3 %}width:40%;{% else %}width:12%;{% endif %}">{% if range_stage == 3 %}<span class="left">100%</span><span class="middle"> Gold Lvl 1: {{ middle }} </span>{% endif %}<span class="right">200%</span></div><!--
                            --><div class="stage bg-yellow-600" style="{% if range_stage == 4 %}width:40%;{% else %}width:12%;{% endif %}">{% if range_stage == 4 %}<span class="left">200%</span><span class="middle"> Gold Lvl 2: {{ middle }} </span>{% endif %}<span class="right">300%</span></div><!--
                            --><div class="stage bg-yellow-500" style="{% if range_stage == 5 %}width:40%;{% else %}width:12%;{% endif %}">{% if range_stage == 5 %}<span class="left">300%</span><span class="middle"> Gold Lvl 3: {{ middle }} </span>{% endif %}<span class="right">400%</span></div><!--
                            --><div class="stage bg-yellow-400" style="{% if range_stage == 6 %}width:40%;{% else %}width:12%;{% endif %}">{% if range_stage == 6 %}<span class="left">400%</span><span class="middle"> Gold Lvl 4: {{ middle }} </span>{% endif %}<span class="right">500%</span></div>
                        </div>
                    </dd>
                </div>

                {# Position Status #}
                <div class="px-4 py-6 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-0">
                    <dt class="text-sm font-medium leading-6 text-gray-900">Position Status</dt>
                    <dd class="mt-1 text-sm leading-6 text-gray-700 sm:col-span-2 sm:mt-0">
                        {% if shares_owned > 0 or have_alive_options %}
                        <div class="label mb-3">
                        {% if total_debt >= status_total_return_with_current_share_value %}
                            <div class="bg-rose-700 inline-block w-5 h-5 rounded-3xl border border-solid border-black"></div><span class="inline-block ml-2 align-top relative bottom-0.5">UNDERWATER</span>
                            {% set range_stage = 1 %}
                            {% set percent_plus = 0 %}
                            {% set block_percent = (100 + percent_increase_with_current_share_value) %}
                        {% else %}
                            {% if percent_increase_with_current_share_value < 100 %}
                                <div class="bg-green-700 inline-block w-5 h-5 rounded-3xl border border-solid border-black"></div><span class="inline-block ml-2 align-top relative bottom-0.5">PROFITABLE</span>
                                {% set range_stage = 2 %}
                                {% set percent_plus = 12 %}
                                {% set block_percent = percent_increase_with_current_share_value %}
                            {% elseif percent_increase_with_current_share_value < 200 %}
                                <div class="bg-yellow-800 inline-block w-5 h-5 rounded-3xl border border-solid border-black"></div><span class="inline-block ml-2 align-top relative bottom-0.5">GOLD LEVEL 1 (+100%)</span>
                                {% set range_stage = 3 %}
                                {% set percent_plus = 24 %}
                                {% set block_percent = percent_increase_with_current_share_value - 100 %}
                            {% elseif percent_increase_with_current_share_value < 300 %}
                                <div class="bg-yellow-700 inline-block w-5 h-5 rounded-3xl border border-solid border-black"></div><span class="inline-block ml-2 align-top relative bottom-0.5">GOLD LEVEL 2 (+200%)</span>
                                {% set range_stage = 4 %}
                                {% set percent_plus = 36 %}
                                {% set block_percent = percent_increase_with_current_share_value - 200 %}
                            {% elseif percent_increase_with_current_share_value < 400 %}
                                <div class="bg-yellow-600 inline-block w-5 h-5 rounded-3xl border border-solid border-black"></div><span class="inline-block ml-2 align-top relative bottom-0.5">GOLD LEVEL 3 (+300%)</span>
                                {% set range_stage = 5 %}
                                {% set percent_plus = 48 %}
                                {% set block_percent = percent_increase_with_current_share_value - 300 %}
                            {% elseif percent_increase_with_current_share_value < 500 %}
                                <div class="bg-yellow-500 inline-block w-5 h-5 rounded-3xl border border-solid border-black"></div><span class="inline-block ml-2 align-top relative bottom-0.5">GOLD LEVEL 4 (+400%)</span>
                                {% set range_stage = 6 %}
                                {% set percent_plus = 60 %}
                                {% set block_percent = percent_increase_with_current_share_value - 400 %}
                            {% else %}
                                <div class="bg-yellow-400 inline-block w-5 h-5 rounded-3xl border border-solid border-black"></div><span class="inline-block ml-2 align-top relative bottom-0.5">GOLD LEVEL 5 (+500%)</span>
                            {% endif %}
                        {% endif %}
                        </div>
                        {% set marker_percent = percent_plus + (block_percent * 0.4) %}

                        {% set middle = "[" ~ percent_increase_with_current_share_value|number_format(2) ~ "%]"  %}

                        <div class="relative" style="background:white; border:solid 1px black; border-radius:50px; height:30px;">
                            <div class="marker" style="left:calc({{ marker_percent|number_format(2) }}% - {{ marker_nudge }}px)"></div>
                            <div class="stage bg-rose-700" style="{% if range_stage == 1 %}width:40%;{% else %}width:12%;{% endif %} left:0; border-radius: 50px 0 0 50px;">{% if range_stage == 1 %}<span class="left">-100%</span><span class="middle"> Underwater: {{ middle }} </span>{% endif %}<span class="right">0%</span></div><!--
                            --><div class="stage bg-green-600" style="{% if range_stage == 2 %}width:40%;{% else %}width:12%;{% endif %}">{% if range_stage == 2 %}<span class="left">0%</span><span class="middle"> Profitable: {{ middle }} </span>{% endif %}<span class="right">100%</span></div><!--
                            --><div class="stage bg-yellow-700" style="{% if range_stage == 3 %}width:40%;{% else %}width:12%;{% endif %}">{% if range_stage == 3 %}<span class="left">100%</span><span class="middle"> Gold Lvl 1: {{ middle }} </span>{% endif %}<span class="right">200%</span></div><!--
                            --><div class="stage bg-yellow-600" style="{% if range_stage == 4 %}width:40%;{% else %}width:12%;{% endif %}">{% if range_stage == 4 %}<span class="left">200%</span><span class="middle"> Gold Lvl 2: {{ middle }} </span>{% endif %}<span class="right">300%</span></div><!--
                            --><div class="stage bg-yellow-500" style="{% if range_stage == 5 %}width:40%;{% else %}width:12%;{% endif %}">{% if range_stage == 5 %}<span class="left">300%</span><span class="middle"> Gold Lvl 3: {{ middle }} </span>{% endif %}<span class="right">400%</span></div><!--
                            --><div class="stage bg-yellow-400" style="{% if range_stage == 6 %}width:40%;{% else %}width:12%;{% endif %}">{% if range_stage == 6 %}<span class="left">400%</span><span class="middle"> Gold Lvl 4: {{ middle }} </span>{% endif %}<span class="right">500%</span></div>
                        </div>
                        {% else %}
                            You have no share or option positions in this company
                        {% endif %}
                    </dd>
                </div>

                {# Profitablity Status Range Meter #}
                <div class="px-4 py-6 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-0">
                    <dt class="text-sm font-medium leading-6 text-gray-900">Profitablity Status Meter
                        <p class="font-normal text-xs max-w-56 text-gray-700 mt-2">Quick meter to show how many shares you need to sell at the level price to make the company profitable.</p>
                    </dt>
                    <dd class="mt-1 text-sm leading-6 text-gray-700 sm:col-span-2 sm:mt-0">
                        {% if percent_increase > 0 %}
                            {% if percent_increase < 100 %}
                                Already Profitable (<span class="text-green-600">Level 0</span>)
                            {% elseif percent_increase < 200 %}
                                Already Gold Status (<span class="text-yellow-700">Level 1</span>)
                            {% elseif percent_increase < 300 %}
                                Already Gold Status (<span class="text-yellow-600">Level 2</span>)
                            {% elseif percent_increase < 400 %}
                                Already Gold Status (<span class="text-yellow-500">Level 3</span>)
                            {% elseif percent_increase < 500 %}
                                Already Gold Status (<span class="text-yellow-400">Level 4</span>)
                            {% else %}
                                Already Gold Status (<span class="text-yellow-300">Level 5</span>)
                            {% endif %}

                        {% elseif shares_owned == 0 %}
                            You have no share positions to sell to increase profitablilty
                        {% else %}
                            {% set min_price = 0 %}
                            {% set profit_price = ((remaining_till_gold_abs) * 1) / shares_owned|abs %}
                            {% set gold_price_1 = ((remaining_till_gold_abs) * 2) / shares_owned|abs %}
                            {% set gold_price_2 = ((remaining_till_gold_abs) * 4) / shares_owned|abs %}
                            {% set gold_price_3 = ((remaining_till_gold_abs) * 8) / shares_owned|abs %}
                            {% set gold_price_4 = ((remaining_till_gold_abs) * 16) / shares_owned|abs %}
                            {% set gold_price_5 = ((remaining_till_gold_abs) * 32) / shares_owned|abs %}

                            {% if stock.company.currentPrice < profit_price %}
                                {% set range_stage = 1 %}
                                {% set block_percent = (stock.company.currentPrice / profit_price) %}
                                {% set percent_plus = 0 %}
                            {% elseif stock.company.currentPrice < gold_price_1 %}
                                {% set range_stage = 2 %}
                                {% set block_percent = ((stock.company.currentPrice - profit_price) / (gold_price_1 - profit_price)) %}
                                {% set percent_plus = 12 %}
                            {% elseif stock.company.currentPrice < gold_price_2 %}
                                {% set range_stage = 3 %}
                                {% set block_percent = ((stock.company.currentPrice - gold_price_1) / (gold_price_2 - gold_price_1)) %}
                                {% set percent_plus = 24 %}
                            {% elseif stock.company.currentPrice < gold_price_3 %}
                                {% set range_stage = 4 %}
                                {% set block_percent = ((stock.company.currentPrice - gold_price_2) / (gold_price_3 - gold_price_2)) %}
                                {% set percent_plus = 36 %}
                            {% elseif stock.company.currentPrice < gold_price_4 %}
                                {% set range_stage = 5 %}
                                {% set block_percent = ((stock.company.currentPrice - gold_price_3) / (gold_price_4 - gold_price_3)) %}
                                {% set percent_plus = 48 %}
                            {% elseif stock.company.currentPrice < gold_price_5 %}
                                {% set range_stage = 6 %}
                                {% set block_percent = ((stock.company.currentPrice - gold_price_4) / (gold_price_5 - gold_price_4)) %}
                                {% set percent_plus = 60 %}
                            {% else %}
                                {% set range_stage = 6 %}
                                {% set block_percent = 1 %}
                                {% set percent_plus = 60 %}
                            {% endif %}

                            {% set marker_percent = percent_plus + (block_percent * 40) %}

                            {% set middle = "[$" ~ stock.company.currentPrice|round(2,"floor")|number_format(2) ~ "]"  %}
                            <div class="relative" style="background:white; border:solid 1px black; border-radius:50px; height:30px;">
                                <div class="marker" style="left:calc({{ marker_percent|number_format(2) }}% - {{ marker_nudge }}px)"></div>
                                <div class="stage bg-rose-700" style="{% if range_stage == 1 %}width:40%;{% else %}width:12%;{% endif %} left:0; border-radius: 50px 0 0 50px;">{% if range_stage == 1 %}<span class="left">$0.00</span><span class="middle"> Underwater: {{ middle }} </span>{% endif %}<span class="right">${{ profit_price|number_format(2) }}</span></div><!--
                            --><div class="stage bg-green-600" style="{% if range_stage == 2 %}width:40%;{% else %}width:12%;{% endif %}">{% if range_stage == 2 %}<span class="left">${{ profit_price|number_format(2) }}</span><span class="middle"> Profitable: {{ middle }} </span>{% endif %}<span class="right">${{ gold_price_1|number_format(2) }}</span></div><!--
                            --><div class="stage bg-yellow-700" style="{% if range_stage == 3 %}width:40%;{% else %}width:12%;{% endif %}">{% if range_stage == 3 %}<span class="left">${{ gold_price_1|number_format(2) }}</span><span class="middle"> Profit Price lvl 1: {{ middle }} </span>{% endif %}<span class="right">${{ gold_price_2|number_format(2) }}</span></div><!--
                            --><div class="stage bg-yellow-600" style="{% if range_stage == 4 %}width:40%;{% else %}width:12%;{% endif %}">{% if range_stage == 4 %}<span class="left">${{ gold_price_2|number_format(2) }}</span><span class="middle"> Profit Price lvl 2: {{ middle }} </span>{% endif %}<span class="right">${{ gold_price_3|number_format(2) }}</span></div><!--
                            --><div class="stage bg-yellow-500" style="{% if range_stage == 5 %}width:40%;{% else %}width:12%;{% endif %}">{% if range_stage == 5 %}<span class="left">${{ gold_price_3|number_format(2) }}</span><span class="middle"> Profit Price lvl 3: {{ middle }} </span>{% endif %}<span class="right">${{ gold_price_4|number_format(2) }}</span></div><!--
                            --><div class="stage bg-yellow-400" style="{% if range_stage == 6 %}width:40%;{% else %}width:12%;{% endif %}">{% if range_stage == 6 %}<span class="left">${{ gold_price_4|number_format(2) }}</span><span class="middle"> Profit Price Lvl 4: {{ middle }} </span>{% endif %}<span class="right">${{ gold_price_5|number_format(2) }}</span></div>
                            </div>

                            <button id="legend_btn" class="my-5 bg-blue-500 text-white py-2 px-4 rounded font-bold hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50" onclick="showLegend();">Show Legend</button>

                            <div class="legend py-5" id="price_range_legend" style="display:none;">
                                {% if stock.company.currentPrice > profit_price %}
                                    {% set shares_to_sell = ((remaining_till_gold|abs + 9.95) / stock.company.currentPrice) %}
                                    Profit Price = ${{ profit_price|number_format(2) }} - Sell {{ shares_to_sell|round(0, 'ceil') }} shares at ${{ stock.company.currentPrice|number_format(2) }} to become profitable<br />
                                {% else %}
                                    Profit Price = ${{ profit_price|number_format(2) }} - Sell all {{ shares_owned }} shares at {{ profit_price|number_format(2) }} to become profitable<br />
                                {% endif %}
                                Profit Price Level 1 (Sell 1/2) = ${{ gold_price_1|number_format(2) }} - Sell {{ (shares_owned / 2)|round(0,'ceil')  }} Shares to become profitable<br />
                                Profit Price Level 2 (Sell 1/4) = ${{ gold_price_2|number_format(2) }} - Sell {{ (shares_owned / 4)|round(0,'ceil')  }} Shares to become profitable<br />
                                Profit Price Level 3 (Sell 1/8) = ${{ gold_price_3|number_format(2) }} - Sell {{ (shares_owned / 8)|round(0,'ceil')  }} Shares to become profitable<br />
                                Profit Price Level 4 (Sell 1/16) = ${{ gold_price_4|number_format(2) }} - Sell {{ (shares_owned / 16)|round(0,'ceil')  }} Shares to become profitable<br />
                                Profit Price Level 5 (Sell 1/32) = ${{ gold_price_5|number_format(2) }} - Sell {{ (shares_owned / 32)|round(0,'ceil')  }} Shares to become profitable<br />
                            </div>


                            <script>
                                let legend_hidden = true;
                                function showLegend(){
                                    if (!legend_hidden){
                                        document.getElementById("legend_btn").innerHTML = "Show Legend";
                                        document.getElementById('price_range_legend').style.display = 'none';
                                        legend_hidden = true;
                                    } else {
                                        document.getElementById("legend_btn").innerHTML = "Hide Legend";
                                        document.getElementById('price_range_legend').style.display = 'block';
                                        legend_hidden = false;
                                    }
                                }
                            </script>
                        {% endif %}
                    </dd>
                </div>

                {# Written Options #}
                <div class="px-4 py-6 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-0">
                    <dt class="text-sm font-medium leading-6 text-gray-900">Written Options</dt>
                    <dd class="mt-1 text-sm leading-6 text-gray-700 sm:col-span-2 sm:mt-0">
                        {% if stock.coveredCalls is empty %}
                            No covered calls sold on this stock
                        {% else %}
                        <table style="text-align:center;">
                            <tr>
                                <th>Price |</th>
                                <th><small>Contracts</small> |</th>
                                <th>Strike |</th>
                                <th><small>Expiry Date |</small></th>
                                <th>Status |</th>
                                <th>Earned | </th>
                                <th><small>Buy/Expire +/-</small> | </th>
                                <th><small>Strike +/-</small> | </th>
                                <th>% |</th>
                                <th>Stats <small>(EPS|SBP|SEP)</small></th>
                            </tr>
                            {% for cc in stock.coveredCalls %}
                            <tr>
                                {% if cc.buyout %}
                                    {% set cc_status = "Buyout" %}
                                {% elseif cc.expired %}
                                    {% set cc_status = "Expired" %}
                                {% elseif cc.exercised %}
                                    {% set cc_status = "Exercised" %}
                                {% else %}
                                    {% if cc.partiallyBoughtout %}
                                        {% set cc_status = "Ongoing/PBO" %}
                                    {% else %}
                                        {% set cc_status = "Ongoing" %}
                                    {% endif %}
                                {% endif %}

                                {% set cc_earned = ((cc.price * cc.contracts * 100) - 9.95 - (1.25 * cc.contracts)) %}

                                {% if cc.buyout or cc.partiallyBoughtout %}
                                    {% set cc_earned = cc_earned - cc.buyoutPrice %}
                                {% endif %}

                                {% set eps = cc_earned / (cc.contracts * 100)  %}

                                {% if cc.exercised %}
                                    {% set cc_diff = cc.strike - (cc.stockBuyPrice - eps) %}
                                {% else %}
                                    {% set cc_diff = cc.stockExpiryPrice - (cc.stockBuyPrice - eps) %}
                                {% endif %}

                                {% if cc_status == "Ongoing" or cc_status == "Ongoing/PBO" %}
                                    {% set cc_expiry_price = stock.company.currentPrice|number_format(2) %}
                                {% else %}
                                    {% set cc_expiry_price = cc.stockExpiryPrice %}
                                {% endif %}

                                {% set cc_be_diff = (cc.stockBuyPrice - cc_expiry_price) * -1 %}
                                {% set cc_se_diff = (cc_expiry_price - cc.strike) %}
                                {% set cc_se_per = ((cc_expiry_price - (cc.strike - 0.02)) / (cc.strike - 0.02)) * 100 %}
                                {% set cc_ab_per = cc_se_per %}
                                {% set cc_away_from_target = 100 + cc_ab_per %}

                                {% set cc_be_diff2 = (cc.stockBuyPrice - stock.company.currentPrice) * -1 %}
                                {% set cc_se_diff2 = (stock.company.currentPrice - cc.strike) %}
                                {% set cc_se_per2 = ((stock.company.currentPrice - (cc.strike - 0.02)) / (cc.strike - 0.02)) * 100 %}
                                {% set cc_ab_per2 = cc_se_per2 %}
                                {% set cc_away_from_target2 = 100 + cc_ab_per2 %}


                                <td>{{ cc.price|number_format(2) }}</td>
                                <td>{{ cc.contracts }}</td>
                                <td>{{ cc.strike|number_format(2) }}</td>
                                <td>{{ cc.expiry|date("m/d/Y") }}</td>
                                <td>
                                    <small>{{ cc_status }}</small>

                                </td>
                                <td>${{ cc_earned|number_format(2) }}</td>
                                <td class="{% if cc_be_diff > 0 %}green{% else %}red{% endif %}">
                                    <span class="{% if cc_be_diff > 0 %}green{% else %}red{% endif %}">{% if cc_be_diff > 0 %}+{% endif %}{{ cc_be_diff|number_format(2) }}</span>
                                </td>

                                <td class="{% if cc_se_diff < 0 %}green{% else %}red{% endif %}">
                                    <span>{% if cc_se_diff > 0 %}+{% endif %}{{ cc_se_diff|number_format(2) }}</span>
                                </td>

                                {% if cc.buyout or cc.expired or cc.exercised %}
                                    <td class="{% if cc_se_per < 0 %}green{% else %}red{% endif %}">
                                        <span>{{ cc_away_from_target|number_format(1) }}% | </span>
                                    </td>
                                    <td>{{ eps|number_format(3) }} | {{ cc.stockBuyPrice }} | {{ cc.stockExpiryPrice }}</td>
                                {% else %}
                                    {% set cc_be_diff2 = (cc.stockBuyPrice - stock.company.currentPrice) * -1 %}
                                    {% set cc_se_diff2 = (stock.company.currentPrice - cc.strike) %}
                                    {% set cc_se_per2 = ((stock.company.currentPrice - (cc.strike - 0.02)) / (cc.strike - 0.02)) * 100 %}
                                    {% set cc_ab_per2 = cc_se_per2 %}
                                    {% set cc_away_from_target2 = 100 + cc_ab_per2 %}
                                    <td class="{% if cc_se_per < 0 %}green{% else %}red{% endif %}">
                                        <span>{{ cc_away_from_target2|number_format(1) }}% | </span>
                                    </td>
                                    <td>{{ eps|number_format(3) }} | {{ cc.stockBuyPrice }} | {{ cc_expiry_price|number_format(2) }}</td>
                                {% endif %}
                            </tr>

                            {% if cc.writtenOptionRollovers is not empty %}
                            <tr>
                                <td colspan="10">
                                    <table style="font-size: 12px; text-align: center; width: 100%;">
                                        <tr>
                                            <th style="font-size: 14px;">Rollovers:</th>
                                            <th>Price |&nbsp;</th>
                                            <th>Amount |&nbsp;</th>
                                            <th>Old Expiry |&nbsp;</th>
                                            <th>New Expiry |&nbsp;</th>
                                            <th>Old Strike |&nbsp;</th>
                                            <th>New Strike |&nbsp;</th>
                                            <th>Stock RO Price</th>
                                        </tr>
                                        {% for ro in cc.writtenOptionRollovers %}
                                        <tr>
                                            <td></td>
                                            <td>{{ ro.price|number_format(2)  }}</td>
                                            <td>{{ ro.amount|number_format(2) }}</td>
                                            <td>{{ ro.oldExpiry|date("m/d/Y") }}</td>
                                            <td>{{ ro.newExpiry|date("m/d/Y") }}</td>
                                            <td>{{ ro.oldStrike|number_format(2)  }}</td>
                                            <td>{{ ro.newStrike|number_format(2)  }}</td>
                                            <td>{{ ro.stockRolloverPrice|number_format(2)  }}</td>
                                        </tr>
                                        {% endfor %}
                                    </table>

                                </td>
                            </tr>
                            {% endif%}
                        {% endfor %}
                        </table>
                        {% endif %}
                    </dd>
                </div>

                <div class="px-4 py-6 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-0">
                    <dt class="text-sm font-medium leading-6 text-gray-900">Dividend</dt>
                    <dd class="mt-1 text-sm leading-6 text-gray-700 sm:col-span-2 sm:mt-0">
                        {% if stock.company.paysDividend %}
                            <div class="flex flex-col">
                                <div class="-m-1.5 overflow-x-auto">
                                    <div class="p-1.5 min-w-full inline-block align-middle">
                                        <div class="border rounded-lg shadow overflow-hidden dark:border-neutral-700 dark:shadow-gray-900">
                                            <table class="min-w-full divide-y divide-gray-200 dark:divide-neutral-700">
                                                <thead>
                                                <tr class="divide-x divide-gray-200 dark:divide-neutral-700">
                                                    <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase dark:text-neutral-500">Total Amount</th>
                                                    <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase dark:text-neutral-500">Payments</th>
                                                    <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase dark:text-neutral-500">Average</th>
                                                    <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase dark:text-neutral-500">Latest</th>
                                                </tr>
                                                </thead>
                                                <tbody class="divide-y divide-gray-200 dark:divide-neutral-700">
                                                <tr>
                                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-center font-medium text-gray-800 dark:text-neutral-200"><span class="text-3xl">${{ dividend_total|number_format(2) }}</span></td>
                                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-center font-medium text-gray-800 dark:text-neutral-200"><span class="text-3xl">{{ dividend_total_payments }}</span></td>
                                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-center font-medium text-gray-800 dark:text-neutral-200"><span class="text-3xl">${{ dividend_average|number_format(2) }}</span></td>
                                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-center font-medium text-gray-800 dark:text-neutral-200"><span class="text-3xl">${{ dividend_latest|number_format(2) }}</span></td>
                                                </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            Company does not pay a dividend
                        {% endif %}
                    </dd>
                </div>

                {# Plays History #}
                <div class="px-4 py-6 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-0">
                    <dt class="text-sm font-medium leading-6 text-gray-900">Plays History</dt>
                    <dd class="mt-1 text-sm leading-6 text-gray-700 sm:col-span-2 sm:mt-0">
                        <table style="width:100%;">
                            <tr>
                                <th>Play Name</th>
                                <th>Start Date</th>
                                <th>End Date</th>
                                <th>Amount Earned</th>
                            </tr>
                            {% for play in stock.plays %}
                                {% set current_price = play.stock.company.currentPrice %}

                                {% set bought = (play.shareAverage * play.sharesTotal) + (9.95 * play.sharesTotalBuys) %}
                                {% set bought = bought + (play.contractsAverage * play.contractsTotal) + (9.95 * play.contractsTotalBuys) + (1.25 * play.contractsTotal) %}

                                {% set sold = play.totalSold + play.writtenOptionTotal %}
                                {% set total_percent = (((sold) - bought) / bought) * 100 %}

                                {% set earned = sold - bought %}

                                <tr style="text-align: center;">
                                <td>{{ play.name }}</td>
                                <td>{{ play.startDate|date("m/d/Y") }}</td>
                                <td>{% if play.isFinished %}{{ play.endDate|date("m/d/Y") }}{% else %}present{% endif %}</td>
                                <td>${{ earned|number_format(2) }}</td>
                            </tr>
                            {% endfor %}
                        </table>
                    </dd>
                </div>

                {# Share Ownership History #}
                <div class="px-4 py-6 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-0">
                    <dt class="text-sm font-medium leading-6 text-gray-900">Share Ownership History</dt>
                    <dd class="mt-1 text-sm leading-6 text-gray-700 sm:col-span-2 sm:mt-0">
                        <table style="width: 100%">
                            <tr>
                                <th>BUYS</th>
                                <th>SELLS</th>
                            </tr>
                            <tr>
                                <td style="vertical-align: top; width: 50%;">
                                    <table class="buy_table" style="width: 100%;">
                                        <tr>
                                            <th>DATE</th>
                                            <th>AMOUNT</th>
                                            <th>PRICE</th>
                                        </tr>
                                        {% for buy in stock.shareBuys %}
                                            <tr style="text-align: center">
                                                <td>{{ buy.date|date("m/d/Y") }}</td>
                                                <td>{{ buy.amount }}</td>
                                                <td>{{ buy.price }}</td>
                                            </tr>
                                        {% endfor %}
                                    </table>
                                </td>
                                <td style="vertical-align: top; width: 50%;">
                                    <table class="sell_table" style="width: 100%;">
                                        <tr>
                                            <th>DATE</th>
                                            <th>AMOUNT</th>
                                            <th>PRICE</th>
                                        </tr>
                                        {% for sell in stock.shareSells %}
                                            <tr style="text-align: center">
                                                <td>{{ sell.date|date("m/d/Y") }}</td>
                                                <td>{{ sell.amount }}</td>
                                                <td>{{ sell.price }}</td>
                                            </tr>
                                        {% endfor %}
                                    </table>
                                </td>
                            </tr>
                        </table>
                    </dd>
                </div>

                {# Options Ownership History #}
                <div class="px-4 py-6 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-0">
                    <dt class="text-sm font-medium leading-6 text-gray-900">Options Ownership History</dt>
                    <dd class="mt-1 text-sm leading-6 text-gray-700 sm:col-span-2 sm:mt-0">
                        <table class="buy_table" style="width: 100%; vertical-align: top;">
                            <tr>
                                <th>Buy Date</th>
                                <th>Expiry Date</th>
                                <th>Contracts</th>
                                <th>Average</th>
                                <th>Rollover</th>
                                <th>Sell Date</th>
                                <th>Sell Price</th>
                            </tr>

                            {% for option in stock.options %}
                                <tr style="text-align: center">
                                    <td>{{ option.buyDate|date("m/d/Y") }}</td>
                                    <td>{{ option.expiry|date("m/d/Y") }}</td>
                                    <td>{{ option.totalContractsSold }}/{{ option.totalContracts }}</td>
                                    <td>{{ option.average|number_format(2) }}</td>
                                    <td>
                                        {% set ro = 0 %}
                                        {% for rollover in option.optionRollovers %}
                                            {% set ro = ro + ((((rollover.oldPrice - rollover.newPrice) * rollover.contracts) * 100)) - (9.95 + (2.50 * rollover.contracts)) %}
                                        {% endfor %}
                                        ${{ ro|number_format(2) }}
                                    </td>
                                    {% if option.expired and option.totalContractsSold == 0 %}
                                        <td colspan="2">Expired</td>
                                    {% elseif option.totalContractsSold == 0 %}
                                        <td colspan="2">No Contracts sold</td>
                                    {% else %}
                                        <td>{{ option.sellDate|date("m/d/Y") }}</td>
                                        <td>${{ option.sellPrice|number_format(2) }}</td>
                                    {% endif %}
                                </tr>
                            {% endfor %}
                        </table>
                    </dd>
                </div>

                {# Attachments #}
                <div class="px-4 py-6 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-0">
                    <dt class="text-sm font-medium leading-6 text-gray-900">Attachments</dt>
                    <dd class="mt-2 text-sm text-gray-900 sm:col-span-2 sm:mt-0">
                        <ul role="list" class="divide-y divide-gray-100 rounded-md border border-gray-200">
                            <li class="flex items-center justify-between py-4 pl-4 pr-5 text-sm leading-6">
                                <div class="flex w-0 flex-1 items-center">
                                    <svg class="h-5 w-5 flex-shrink-0 text-gray-400" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                        <path fill-rule="evenodd" d="M15.621 4.379a3 3 0 00-4.242 0l-7 7a3 3 0 004.241 4.243h.001l.497-.5a.75.75 0 011.064 1.057l-.498.501-.002.002a4.5 4.5 0 01-6.364-6.364l7-7a4.5 4.5 0 016.368 6.36l-3.455 3.553A2.625 2.625 0 119.52 9.52l3.45-3.451a.75.75 0 111.061 1.06l-3.45 3.451a1.125 1.125 0 001.587 1.595l3.454-3.553a3 3 0 000-4.242z" clip-rule="evenodd" />
                                    </svg>
                                    <div class="ml-4 flex min-w-0 flex-1 gap-2">
                                        <span class="truncate font-medium">resume_back_end_developer.pdf</span>
                                        <span class="flex-shrink-0 text-gray-400">2.4mb</span>
                                    </div>
                                </div>
                                <div class="ml-4 flex-shrink-0">
                                    <a href="#" class="font-medium text-indigo-600 hover:text-indigo-500">Download</a>
                                </div>
                            </li>
                            <li class="flex items-center justify-between py-4 pl-4 pr-5 text-sm leading-6">
                                <div class="flex w-0 flex-1 items-center">
                                    <svg class="h-5 w-5 flex-shrink-0 text-gray-400" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                        <path fill-rule="evenodd" d="M15.621 4.379a3 3 0 00-4.242 0l-7 7a3 3 0 004.241 4.243h.001l.497-.5a.75.75 0 011.064 1.057l-.498.501-.002.002a4.5 4.5 0 01-6.364-6.364l7-7a4.5 4.5 0 016.368 6.36l-3.455 3.553A2.625 2.625 0 119.52 9.52l3.45-3.451a.75.75 0 111.061 1.06l-3.45 3.451a1.125 1.125 0 001.587 1.595l3.454-3.553a3 3 0 000-4.242z" clip-rule="evenodd" />
                                    </svg>
                                    <div class="ml-4 flex min-w-0 flex-1 gap-2">
                                        <span class="truncate font-medium">coverletter_back_end_developer.pdf</span>
                                        <span class="flex-shrink-0 text-gray-400">4.5mb</span>
                                    </div>
                                </div>
                                <div class="ml-4 flex-shrink-0">
                                    <a href="#" class="font-medium text-indigo-600 hover:text-indigo-500">Download</a>
                                </div>
                            </li>
                        </ul>
                    </dd>
                </div>
            </dl>
        </div>
    </div>

    <script>
        var search_open = false;
        $(document).ready(function() {
            $("#stocksearch").on('click', function() {
                if(!search_open) {
                    search_open = true;
                    $("#searchresults li").show();
                    $("#searchresults").show();
                } else {
                    search_open = false;
                    $("#searchresults").hide();
                }
            });

            $("#stocksearch").on('keyup', function(){
                search_open = true;
                var search_value = $(this).val().toLowerCase();

                if (search_value.trim() === "") {
                    $("#searchresults").hide();
                } else {
                    $("#searchresults li").each(function(){
                        var $li = $(this);
                        var name = $li.attr("data-name").toLowerCase();
                        var ticker = $li.attr("data-ticker").toLowerCase();
                        var sector = $li.attr("data-sector").toLowerCase();
                        $li.hide();

                        if(name.includes(search_value.trim()) || ticker.includes(search_value.trim()) || sector.includes(search_value.trim())) {
                            $li.show();
                        }
                    });

                    $("#searchresults").show();
                }


            })
        });
    </script>
{% endblock %}