{% extends 'base.html.twig' %}

{% block title %}Written Options{% endblock %}

{% block body %}
    <div class="py-4">
        <a href="/stocks/writtenoptions/write" class="rounded-md px-3.5 py-2.5 text-sm font-semibold button-shadow bg-gradient-to-r from-emerald-500 to-lime-600 text-white hover:bg-gradient-to-r hover:from-lime-400 hover:to-lime-500">Write a New Option</a><br />
    </div>
    
    <div class="flex gap-x-4 pt-5">
        <div class="flex flex-1 flex-col grid-cols-1 rounded-3xl bg-gray-100 px-5">
            <h3 class="text-2xl font-semibold pt-3 pb-2">How to Write a Covered Call</h3>
            <p class="instruct pb-4">
                To write a covered call, purchase 100 shares of stock from whatever ticker/company you want create the contract for.
                When you have them, open the option form like you would when buying a regular call/put contract.
                Select the strike/expiry for your call and then select <strong>Sell to Open</strong>. Make sure you select <strong>covered</strong> from the covered dropdown as well.
            </p>

            <img style="width:99%" src="/assets/images/cc_instructions.png" alt="">
            <small class="pl-3 pt-2 pb-3">BMO Investerline 2.0 orderform for Covered Call Option selling</small>
        </div>
        <div class="flex flex-1 flex-col grid-cols-1 rounded-3xl bg-gray-100 px-5">
            <h3 class="text-2xl font-semibold pt-3 pb-2">How to Write a Cash Secured Put</h3>
            <p class="instruct pb-4">
                To write a Cash Secured Put, you have the cash on hand to purchase 100 shares of stock you are contracting for at the strike you have selected.
                When you have the money, open the option form like you would when buying a regular call/put contract.
                Select the strike/expiry for your put and then select <strong>Sell to Open</strong>. Make sure you select <strong>covered</strong> from the covered dropdown as well.
            </p>

            <img style="width:99%" src="/assets/images/csp_instructions.png" alt="">
            <small class="pl-5 pt-2 pb-3">BMO Investerline 2.0 orderform for Cash Secured Put Option selling</small>
        </div>
    </div>

    <div class="py-10 bg-white text-start">
        <div class="max-w-7xl mx-auto">
            <div class="px-4 sm:px-6 lg:px-8">
                <div class="flex sm:items-center">
                    <div class="flex-1">
                        <h1 class="m-0 text-base font-semibold leading-6 text-gray-900">Active Option Contracts</h1>
                        <p class="mt-2 text-sm leading-5 text-gray-700">A list of all the written option contracts in your account that are still active</p>
                    </div>
                </div>

                <div class="mt-8 flow-root">
                    <div class="mx-[-1rem] my-[-0.5rem] overflow-x-auto sm:mx-6 lg:mx-[-2rem]">
                        <div class="inline-block min-w-full py-2 align-middle sm:px-6 lg:px-8">
                            <table class="indent-0 border-inherit border-collapse min-w-full table-table table-body">
                                <thead>
                                    <tr>
                                        <th scope="col" class="py-3.5 pl-4 pr-3 text-left text-sm leading-5 font-semibold text-gray-900 sm:pl-0">Company</th>
                                        <th scope="col" class="pl-3 py-3.5 pr-3 text-left text-sm leading-5 font-semibold text-gray-900">Contract Info</th>
                                        <th scope="col" class="pl-3 py-3.5 pr-3 text-left text-sm leading-5 font-semibold text-gray-900">Earned</th>
                                        <th scope="col" class="pl-3 py-3.5 pr-3 text-left text-sm leading-5 font-semibold text-gray-900">ðŸŽ¯%</th>
                                        <th scope="col" class="pl-3 py-3.5 pr-3 text-left text-sm leading-5 font-semibold text-gray-900">Ask</th>
                                        <th scope="col" class="pl-3 py-3.5 pr-3 text-left text-sm leading-5 font-semibold text-gray-900">Days Left</th>
                                        <th scope="col" class="relative pl-3 py-3.5 pr-4 text-sm leading-5 font-semibold text-gray-900 sm:pr-0">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white">
                                {% set total_earned = 0 %}
                                {% set old_wo = [] %}
                                {% for wo in written_options|sort((a, b) => a.expiry <=> b.expiry) %}
                                    {% if wo.exercised or wo.expired %}
                                        {% set old_wo = old_wo|merge([wo]) %}
                                    {% else %}
                                        {% set datePost = wo.expiry|date('d-m-Y') %}
                                        {% set today = "now"|date('d-m-Y') %}
                                        {% set difference = date(today).diff(date(datePost))%}
                                        {% set leftDays = difference.days %}
                                        {% set pastExpiry = difference.invert %}
                                        {% set earned = ((wo.price * wo.contracts * 100) - 9.95 - (1.25 * wo.contracts)) %}
                                        {% set current_per = ((wo.stock.currentPrice - (wo.strike - 0.02)) / (wo.strike - 0.02)) * 100 %}
                                        {% set ab_per = current_per %}
                                        {% set away_from_target = 100 + ab_per %}
                                        {% set min_buyback = wo.price - 0.025 - (0.2 / wo.contracts)  %}
                                    <tr>
                                        <td class="whitespace-nowrap py-5 pl-3 text-sm sm:pl-0">
                                            <div class="w-28 h-28 p-3 shadow rounded-full" style="background-color:#{{ wo.stock.bgColor }};">
                                                <a href="/stocks/details/{{ wo.stock.id }}"><img src="/assets/images/company_logos/{{ wo.stock.ticker }}.jpg" alt="{{ wo.stock.ticker }} Logo" class="block align-middle max-w-full w-27 h-27 rounded-full" /></a>
                                            </div>
                                        </td>
                                        <td class="whitespace-nowrap px-3 py-5 text-sm text-gray-500">
                                            <div class="ml-4 text-left">
                                                <div class="font-medium text-gray-900">{{ wo.contracts }} {% if wo.contractType == 1 %}Covered Call{% else %}Cash Secured Put{% endif%} {% if wo.contracts == 1 %}Contract{% else %}Contracts{% endif %}</div>
                                                {#                                            <div class="mt-1 text-gray-500"><span class="font-semibold text-gray-900">Expires:</span> 02/07/2023 | <span class="font-semibold text-gray-900">Price:</span> 0.31 | <span class="font-semibold text-gray-900">Strike:</span> $7.00</div>#}
                                                <div class="mt-1 text-gray-500"><span class="font-semibold text-gray-900">Expires:</span> {{ wo.expiry|date("m/d/Y") }}</div>
                                                <div class="mt-1 text-gray-500"><span class="font-semibold text-gray-900">Price:</span> {{ wo.price|number_format(2) }}</div>
                                                <div class="mt-1 text-gray-500"><span class="font-semibold text-gray-900">Strike:</span> ${{ wo.strike|number_format(2) }}</div>
                                                <div class="mt-1 text-gray-500"><span class="font-semibold text-gray-900">Max Buyback Price:</span> ${{ min_buyback|number_format(2) }}</div>
                                            </div>
                                        </td>
                                        <td class="whitespace-nowrap px-3 py-5 text-sm text-gray-500">${{ earned|number_format(2) }}</td>
                                        <td class="whitespace-nowrap px-3 py-5 text-sm text-gray-500">
                                            {% if away_from_target <= 10 %}
                                            <span class="inline-flex items-center rounded-md bg-red-500 px-2 py-1 text-xs font-medium text-red-900 pill_shadow ring-inset ring-red-900/[0.20]">{{ away_from_target|number_format(2) }}%</span><br />
                                            {% elseif away_from_target > 10 and away_from_target < 20 %}
                                            <span class="inline-flex items-center rounded-md bg-red-300 px-2 py-1 text-xs font-medium text-red-800 pill_shadow ring-inset ring-red-900/[0.20]">{{ away_from_target|number_format(2) }}%</span><br />
                                            {% elseif away_from_target >= 20 and away_from_target < 30 %}
                                            <span class="inline-flex items-center rounded-md bg-red-200 px-2 py-1 text-xs font-medium text-red-700 pill_shadow ring-inset ring-red-700/[0.20]">{{ away_from_target|number_format(2) }}%</span><br />
                                            {% elseif away_from_target >= 30 and away_from_target < 40 %}
                                            <span class="inline-flex items-center rounded-md bg-red-100 px-2 py-1 text-xs font-medium text-red-600 pill_shadow ring-inset ring-red-600/[0.20]">{{ away_from_target|number_format(2) }}%</span><br />
                                            {% elseif away_from_target >= 40 and away_from_target < 50 %}
                                            <span class="inline-flex items-center rounded-md bg-red-50 px-2 py-1 text-xs font-medium text-red-600 pill_shadow ring-inset ring-red-600/[0.20]">{{ away_from_target|number_format(2) }}%</span><br />
                                            {% elseif away_from_target >= 50 and away_from_target < 60 %}
                                            <span class="inline-flex items-center rounded-md bg-green-50 px-2 py-1 text-xs font-medium text-green-600 pill_shadow ring-inset ring-green-600/[0.20]">{{ away_from_target|number_format(2) }}%</span><br />
                                            {% elseif away_from_target >= 60 and away_from_target < 70 %}
                                            <span class="inline-flex items-center rounded-md bg-green-100 px-2 py-1 text-xs font-medium text-green-600 pill_shadow ring-inset ring-green-600/[0.20]">{{ away_from_target|number_format(2) }}%</span><br />
                                            {% elseif away_from_target >= 70 and away_from_target < 80 %}
                                            <span class="inline-flex items-center rounded-md bg-green-200 px-2 py-1 text-xs font-medium text-green-700 pill_shadow ring-inset ring-green-700/[0.20]">{{ away_from_target|number_format(2) }}%</span><br />
                                            {% elseif away_from_target >= 80 and away_from_target < 90 %}
                                            <span class="inline-flex items-center rounded-md bg-green-300 px-2 py-1 text-xs font-medium text-green-800 pill_shadow ring-inset ring-green-900/[0.20]">{{ away_from_target|number_format(2) }}%</span><br />
                                            {% elseif away_from_target >= 90 and away_from_target < 100.01 %}
                                            <span class="inline-flex items-center rounded-md bg-green-500 px-2 py-1 text-xs font-medium text-green-900 pill_shadow ring-inset ring-green-900/[0.20]">{{ away_from_target|number_format(2) }}%</span><br />
                                            {% elseif away_from_target >= 100.01 and away_from_target < 110 %}
                                            <span class="inline-flex items-center rounded-md bg-red-50 px-2 py-1 text-xs font-medium text-red-600 pill_shadow ring-inset ring-red-600/[0.20]">{{ away_from_target|number_format(2) }}%</span><br />
                                            {% elseif away_from_target >= 110 and away_from_target < 120 %}
                                            <span class="inline-flex items-center rounded-md bg-red-100 px-2 py-1 text-xs font-medium text-red-600 pill_shadow ring-inset ring-red-600/[0.20]">{{ away_from_target|number_format(2) }}%</span><br />
                                            {% elseif away_from_target >= 120 and away_from_target < 130 %}
                                            <span class="inline-flex items-center rounded-md bg-red-200 px-2 py-1 text-xs font-medium text-red-700 pill_shadow ring-inset ring-red-700/[0.20]">{{ away_from_target|number_format(2) }}%</span><br />
                                            {% elseif away_from_target >= 130 and away_from_target < 140 %}
                                            <span class="inline-flex items-center rounded-md bg-red-300 px-2 py-1 text-xs font-medium text-red-800 pill_shadow ring-inset ring-red-900/[0.20]">{{ away_from_target|number_format(2) }}%</span><br />
                                            {% else %}
                                            <span class="inline-flex items-center rounded-md bg-red-500 px-2 py-1 text-xs font-medium text-red-900 pill_shadow ring-inset ring-red-900/[0.20]">{{ away_from_target|number_format(2) }}%</span><br />
                                            {% endif %}
                                        </td>
                                        <td class="whitespace-nowrap px-3 py-5 text-sm text-gray-500">{{ wo.ask }}</td>
                                        <td class="whitespace-nowrap px-3 py-5 text-sm text-gray-500">
                                            {% set dl = (datePost == today) ? 'Today' : (leftDays == 1 and not pastExpiry) ? 'Tomorrow' : (pastExpiry and leftDays == 1) ? '<span style="color:red">Expired ' ~ leftDays ~ ' Day Ago</span>' : (pastExpiry) ? '<span style="color:red">Expired ' ~ leftDays ~ ' Days Ago</span>' : leftDays ~ " Days" %}
                                            {{ dl|raw }}
                                        </td>


                                        <td class="relative whitespace-nowrap py-5 pl-3 pr-4 text-right text-sm font-medium sm:pr-0">
                                            <div class="flex items-center justify-center">
                                                <span class="isolate inline-flex rounded-md button-shadow border-2 border-gray-200">
                                                    <a href="/stocks/writtenoption/expire/{{ wo.id }}" class="relative inline-flex items-center bg-white rounded-l-md px-3 py-2 text-sm font-semibold text-gray-900 button-shadow ring-inset ring-gray-300 border-r-2 border-gray-200 hover:bg-gradient-to-r from-emerald-500 to-lime-600 hover:text-white">
                                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-5 mr-1.5">
                                                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12c0 1.268-.63 2.39-1.593 3.068a3.745 3.745 0 0 1-1.043 3.296 3.745 3.745 0 0 1-3.296 1.043A3.745 3.745 0 0 1 12 21c-1.268 0-2.39-.63-3.068-1.593a3.746 3.746 0 0 1-3.296-1.043 3.745 3.745 0 0 1-1.043-3.296A3.745 3.745 0 0 1 3 12c0-1.268.63-2.39 1.593-3.068a3.745 3.745 0 0 1 1.043-3.296 3.746 3.746 0 0 1 3.296-1.043A3.746 3.746 0 0 1 12 3c1.268 0 2.39.63 3.068 1.593a3.746 3.746 0 0 1 3.296 1.043 3.746 3.746 0 0 1 1.043 3.296A3.745 3.745 0 0 1 21 12Z" />
                                                        </svg>
                                                        Expire
                                                    </a>
                                                    <a href="/stocks/writtenoption/rollover/{{ wo.id }}" class="relative ml-[-1px] inline-flex items-center bg-white px-3 py-2 text-sm font-semibold text-gray-900 button-shadow ring-inset ring-gray-300 border-r-2 border-gray-200 hover:bg-gradient-to-r from-indigo-400 to-cyan-400 hover:text-white">
                                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-5 mr-1.5">
                                                            <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" />
                                                        </svg>
                                                        Rollover
                                                    </a>
                                                    <a href="/stocks/writtenoption/buytoclose/{{ wo.id }}" class="relative ml-[-1px] inline-flex items-center bg-white px-3 py-2 text-sm font-semibold text-gray-900 button-shadow ring-inset ring-gray-300 border-r-2 border-gray-200 hover:bg-gradient-to-r from-indigo-400 to-cyan-400 hover:text-white">
                                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-5 mr-1.5">
                                                          <path stroke-linecap="round" stroke-linejoin="round" d="M18.364 18.364A9 9 0 0 0 5.636 5.636m12.728 12.728A9 9 0 0 1 5.636 5.636m12.728 12.728L5.636 5.636" />
                                                        </svg>
                                                        Buy to Close
                                                    </a>
                                                    <a href="/stocks/writtenoption/exercise/{{ wo.id }}" class="relative ml-[-1px] inline-flex items-center rounded-r-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 button-shadow ring-inset ring-gray-300 hover:bg-gradient-to-r from-red-500 to-orange-500 hover:text-white">
                                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-5 mr-1.5">
                                                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m6.75 12H9m1.5-12H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" />
                                                        </svg>
                                                        Exercise
                                                    </a>
                                                </span>
                                            </div>


                                        </td>
                                    </tr>
                                    {% endif %}
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

{% set total_earned = 0 %}
<div class="py-10 bg-white text-start">
        <div class="max-w-7xl mx-auto">
            <div class="px-4 sm:px-6 lg:px-8">
                <div class="flex sm:items-center">
                    <div class="flex-1">
                        <h1 class="m-0 text-base font-semibold leading-6 text-gray-900">Completed Covered Calls</h1>
                        <p class="mt-2 text-sm leading-5 text-gray-700">A list of all the covered calls you have sold(written) in your account including their stock, strike, price, and how close the target finishing price they got.</p>
                    </div>
                </div>

                <div class="mt-8 flow-root">
                    <div class="mx-[-1rem] my-[-0.5rem] overflow-x-auto sm:mx-6 lg:mx-[-2rem]">
                        <div class="inline-block min-w-full py-2 align-middle sm:px-6 lg:px-8">
                            <table class="indent-0 border-inherit border-collapse min-w-full table-table table-body">
                                <thead>
                                    <tr>
                                        <th scope="col" class="py-3.5 pl-4 pr-3 text-left text-sm leading-5 font-semibold text-gray-900 sm:pl-0">Company</th>
                                        <th scope="col" class="pl-3 py-3.5 pr-3 text-left text-sm leading-5 font-semibold text-gray-900">Contract Info</th>
                                        <th scope="col" class="pl-3 py-3.5 pr-3 text-left text-sm leading-5 font-semibold text-gray-900">Status</th>
                                        <th scope="col" class="pl-3 py-3.5 pr-3 text-left text-sm leading-5 font-semibold text-gray-900">Earned</th>
                                        <th scope="col" class="pl-3 py-3.5 pr-3 text-left text-sm leading-5 font-semibold text-gray-900">Diff</th>
                                        <th scope="col" class="pl-3 py-3.5 pr-3 text-left text-sm leading-5 font-semibold text-gray-900">Target ðŸŽ¯%</th>
                                        <th scope="col" class="relative pl-3 py-3.5 pr-4 text-sm leading-5 font-semibold text-gray-900 sm:pr-0">SP Details</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white table-body">
                                {% for wo in old_wo|sort((a, b) => a.expiry <=> b.expiry) %}
                                    {% if wo.contractType == 1 %}
                                        {% set earned = ((wo.price * wo.contracts * 100) - 9.95 - (1.25 * wo.contracts)) %}

                                        {% if wo.buyout %}
                                            {% set earned = earned - wo.buyoutPrice %}
                                        {% endif %}

                                        {% set eps = earned / (wo.contracts * 100)  %}

                                        {% if wo.exercised %}
                                            {% set diff = wo.strike - (wo.stockBuyPrice - eps) %}
                                        {% else %}
                                            {% set diff = wo.stockExpiryPrice - (wo.stockBuyPrice - eps) %}
                                        {% endif %}

                                        {% set be_diff = (wo.stockBuyPrice - wo.stockExpiryPrice) * -1 %}
                                        {% set se_diff = (wo.stockExpiryPrice - wo.strike) %}
                                        {% set se_per = ((wo.stockExpiryPrice - (wo.strike - 0.02)) / (wo.strike - 0.02)) * 100 %}
                                        {% set ab_per = se_per %}
                                        {% set away_from_target = 100 + ab_per %}

                                        {% set total_earned = total_earned + earned %}
                                        <tr>
                                            <td class="whitespace-nowrap py-5 pl-3 text-sm sm:pl-0">
                                                <div class="w-28 h-28 p-3 shadow rounded-full" style="background-color:#{{ wo.stock.bgColor }};">
                                                    <img src="/assets/images/company_logos/{{ wo.stock.ticker }}.jpg" alt="{{ wo.stock.ticker }} Logo" class="block align-middle max-w-full w-27 h-27 rounded-full" />
                                                </div>
                                            </td>
                                            <td class="whitespace-nowrap px-3 py-5 text-sm text-gray-500">
                                                <div class="ml-4 text-left">
                                                    <div class="font-medium text-gray-900">{{ wo.contracts }} {% if wo.contracts == 1 %}Contract{% else %}Contracts{% endif %}</div>
                                                    <div class="mt-1 text-gray-500"><span class="font-semibold text-gray-900">Expires:</span> {{ wo.expiry|date("m/d/Y") }}</div>
                                                    <div class="mt-1 text-gray-500"><span class="font-semibold text-gray-900">Price:</span> {{ wo.price|number_format(2) }}</div>
                                                    <div class="mt-1 text-gray-500"><span class="font-semibold text-gray-900">Strike:</span> ${{ wo.strike|number_format(2) }}</div>
                                                </div>
                                            </td>
                                            <td class="whitespace-nowrap px-3 py-5 text-sm text-gray-500">
                                                {% if wo.exercised %}
                                                     <span class="inline-flex items-center rounded-md bg-teal-50 px-2 py-1 text-xs font-medium text-teal-700 pill_shadow ring-inset ring-teal-600/[0.20]">Exercised</span>
                                                {% elseif wo.buyout %}
                                                     <span class="inline-flex items-center rounded-md bg-amber-50 px-2 py-1 text-xs font-medium text-amber-700 pill_shadow ring-inset ring-amber-600/[0.20]">Buyout</span>
                                                {% else %}
                                                    <span class="inline-flex items-center rounded-md bg-green-50 px-2 py-1 text-xs font-medium text-green-700 pill_shadow ring-inset ring-green-600/[0.20]">Expired</span>
                                                {% endif %}
                                            </td>
                                            <td class="whitespace-nowrap px-3 py-5 text-sm text-gray-500">
                                                ${{ earned|number_format(2) }}
                                            </td>
                                            <td class="whitespace-nowrap px-3 py-5 text-sm text-gray-500">
                                                <div class="ml-4 text-left">
                                                    {# <div class="font-medium text-gray-900"></div>#}
                                                    <div class="mt-1 text-gray-500">
                                                        <span class="font-semibold text-gray-900">Buy/Expire:</span> <span class="{% if be_diff %}text-green-700{% else %}text-red-500{% endif %}">{% if be_diff > 0 %}+{% endif %}{{ be_diff|number_format(2) }}</span>
                                                    </div>
                                                    <div class="mt-1 text-gray-500">
                                                        <span class="font-semibold text-gray-900">Strike:</span> <span class="{% if se_diff %}text-green-700{% else %}text-red-500{% endif %}">{% if se_diff > 0 %}+{% endif %}{{ se_diff|number_format(2) }}</span>
                                                    </div>
                                                </div>
                                            </td>
                                            <td class="whitespace-nowrap px-3 py-5 text-sm text-gray-500">
                                                {% if away_from_target <= 10 %}
                                                    <span class="inline-flex items-center rounded-md bg-red-500 px-2 py-1 text-xs font-medium text-red-900 pill_shadow ring-inset ring-red-900/[0.20]">{{ away_from_target|number_format(2) }}%</span><br />
                                                {% elseif away_from_target > 10 and away_from_target < 20 %}
                                                    <span class="inline-flex items-center rounded-md bg-red-300 px-2 py-1 text-xs font-medium text-red-800 pill_shadow ring-inset ring-red-900/[0.20]">{{ away_from_target|number_format(2) }}%</span><br />
                                                {% elseif away_from_target >= 20 and away_from_target < 30 %}
                                                    <span class="inline-flex items-center rounded-md bg-red-200 px-2 py-1 text-xs font-medium text-red-700 pill_shadow ring-inset ring-red-700/[0.20]">{{ away_from_target|number_format(2) }}%</span><br />
                                                {% elseif away_from_target >= 30 and away_from_target < 40 %}
                                                    <span class="inline-flex items-center rounded-md bg-red-100 px-2 py-1 text-xs font-medium text-red-600 pill_shadow ring-inset ring-red-600/[0.20]">{{ away_from_target|number_format(2) }}%</span><br />
                                                {% elseif away_from_target >= 40 and away_from_target < 50 %}
                                                    <span class="inline-flex items-center rounded-md bg-red-50 px-2 py-1 text-xs font-medium text-red-600 pill_shadow ring-inset ring-red-600/[0.20]">{{ away_from_target|number_format(2) }}%</span><br />
                                                {% elseif away_from_target >= 50 and away_from_target < 60 %}
                                                    <span class="inline-flex items-center rounded-md bg-green-50 px-2 py-1 text-xs font-medium text-green-600 pill_shadow ring-inset ring-green-600/[0.20]">{{ away_from_target|number_format(2) }}%</span><br />
                                                {% elseif away_from_target >= 60 and away_from_target < 70 %}
                                                    <span class="inline-flex items-center rounded-md bg-green-100 px-2 py-1 text-xs font-medium text-green-600 pill_shadow ring-inset ring-green-600/[0.20]">{{ away_from_target|number_format(2) }}%</span><br />
                                                {% elseif away_from_target >= 70 and away_from_target < 80 %}
                                                    <span class="inline-flex items-center rounded-md bg-green-200 px-2 py-1 text-xs font-medium text-green-700 pill_shadow ring-inset ring-green-700/[0.20]">{{ away_from_target|number_format(2) }}%</span><br />
                                                {% elseif away_from_target >= 80 and away_from_target < 90 %}
                                                    <span class="inline-flex items-center rounded-md bg-green-300 px-2 py-1 text-xs font-medium text-green-800 pill_shadow ring-inset ring-green-900/[0.20]">{{ away_from_target|number_format(2) }}%</span><br />
                                                {% elseif away_from_target >= 90 and away_from_target < 100.01 %}
                                                    <span class="inline-flex items-center rounded-md bg-green-500 px-2 py-1 text-xs font-medium text-green-900 pill_shadow ring-inset ring-green-900/[0.20]">{{ away_from_target|number_format(2) }}%</span><br />
                                                {% elseif away_from_target >= 100.01 and away_from_target < 110 %}
                                                    <span class="inline-flex items-center rounded-md bg-red-50 px-2 py-1 text-xs font-medium text-red-600 pill_shadow ring-inset ring-red-600/[0.20]">{{ away_from_target|number_format(2) }}%</span><br />
                                                {% elseif away_from_target >= 110 and away_from_target < 120 %}
                                                    <span class="inline-flex items-center rounded-md bg-red-100 px-2 py-1 text-xs font-medium text-red-600 pill_shadow ring-inset ring-red-600/[0.20]">{{ away_from_target|number_format(2) }}%</span><br />
                                                {% elseif away_from_target >= 120 and away_from_target < 130 %}
                                                    <span class="inline-flex items-center rounded-md bg-red-200 px-2 py-1 text-xs font-medium text-red-700 pill_shadow ring-inset ring-red-700/[0.20]">{{ away_from_target|number_format(2) }}%</span><br />
                                                {% elseif away_from_target >= 130 and away_from_target < 140 %}
                                                    <span class="inline-flex items-center rounded-md bg-red-300 px-2 py-1 text-xs font-medium text-red-800 pill_shadow ring-inset ring-red-900/[0.20]">{{ away_from_target|number_format(2) }}%</span><br />
                                                {% else %}
                                                    <span class="inline-flex items-center rounded-md bg-red-500 px-2 py-1 text-xs font-medium text-red-900 pill_shadow ring-inset ring-red-900/[0.20]">{{ away_from_target|number_format(2) }}%</span><br />
                                                {% endif %}
                                            </td>
                                            <td class="relative whitespace-nowrap py-5 pl-3 pr-4 text-right text-sm font-medium sm:pr-0">
                                                <div class="ml-4 text-left">
                                                    <div class="mt-1 text-gray-500">
                                                        <span class="font-semibold text-gray-900">Earnings Per Share:</span> {{ eps|number_format(3) }}
                                                    </div>
                                                    <div class="mt-1 text-gray-500">
                                                        <span class="font-semibold text-gray-900">Stock Buy Price:</span> {{ wo.stockBuyPrice }}
                                                    </div>
                                                    <div class="mt-1 text-gray-500">
                                                        <span class="font-semibold text-gray-900">Stock Expiry Price:</span> {{ wo.stockExpiryPrice }}
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    {% endif %}
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<div class="py-10 bg-white text-start">
        <div class="max-w-7xl mx-auto">
            <div class="px-4 sm:px-6 lg:px-8">
                <div class="flex sm:items-center">
                    <div class="flex-1">
                        <h1 class="m-0 text-base font-semibold leading-6 text-gray-900">Completed Cash Secured Puts</h1>
                        <p class="mt-2 text-sm leading-5 text-gray-700">A list of all the Cash secured Puts you have sold(written) in your account including their stock, strike, price, and how close the target finishing price they got.</p>
                    </div>
                </div>

                <div class="mt-8 flow-root">
                    <div class="mx-[-1rem] my-[-0.5rem] overflow-x-auto sm:mx-6 lg:mx-[-2rem]">
                        <div class="inline-block min-w-full py-2 align-middle sm:px-6 lg:px-8">
                            <table class="indent-0 border-inherit border-collapse min-w-full table-table table-body">
                                <thead>
                                <tr>
                                    <th scope="col" class="py-3.5 pl-4 pr-3 text-left text-sm leading-5 font-semibold text-gray-900 sm:pl-0">Company</th>
                                    <th scope="col" class="pl-3 py-3.5 pr-3 text-left text-sm leading-5 font-semibold text-gray-900">Contract Info</th>
                                    <th scope="col" class="pl-3 py-3.5 pr-3 text-left text-sm leading-5 font-semibold text-gray-900">Status</th>
                                    <th scope="col" class="pl-3 py-3.5 pr-3 text-left text-sm leading-5 font-semibold text-gray-900">Diff</th>
                                    <th scope="col" class="pl-3 py-3.5 pr-3 text-left text-sm leading-5 font-semibold text-gray-900">Earned</th>
                                    <th scope="col" class="pl-3 py-3.5 pr-3 text-left text-sm leading-5 font-semibold text-gray-900">Target</th>
                                    <th scope="col" class="relative pl-3 py-3.5 pr-4 text-sm leading-5 font-semibold text-gray-900 sm:pr-0">SP Details</th>
                                </tr>
                                </thead>
                                <tbody class="bg-white table-body">
                                {% for wo in old_wo|sort((a, b) => a.expiry <=> b.expiry) %}
                                    {% if wo.contractType == 2 %}
                                        {% set earned = ((wo.price * wo.contracts * 100) - 9.95 - (1.25 * wo.contracts)) %}

                                        {% if wo.buyout %}
                                            {% set earned = earned - wo.buyoutPrice %}
                                        {% endif %}

                                        {% set eps = earned / (wo.contracts * 100)  %}

                                        {% if wo.exercised %}
                                            {% set diff = wo.strike - (wo.stockBuyPrice - eps) %}
                                        {% else %}
                                            {% set diff = wo.stockExpiryPrice - (wo.stockBuyPrice - eps) %}
                                        {% endif %}

                                        {% set be_diff = (wo.stockBuyPrice - wo.stockExpiryPrice) * -1 %}
                                        {% set se_diff = (wo.stockExpiryPrice - wo.strike) %}
                                        {% set se_per = ((wo.stockExpiryPrice - (wo.strike - 0.02)) / (wo.strike - 0.02)) * 100 %}
                                        {% set ab_per = se_per %}
                                        {% set away_from_target = 100 + ab_per %}

                                        {% set total_earned = total_earned + earned %}
                                        <tr>
                                            <td class="whitespace-nowrap py-5 pl-3 text-sm sm:pl-0">
                                                <div class="w-28 h-28 p-3 shadow rounded-full" style="background-color:#{{ wo.stock.bgColor }};">
                                                    <a href="/stocks/details/{{ wo.stock.id }}"><img src="/assets/images/company_logos/{{ wo.stock.ticker }}.jpg" alt="{{ wo.stock.ticker }} Logo" class="block align-middle max-w-full w-27 h-27 rounded-full" /></a>
                                                </div>
                                            </td>
                                            <td class="whitespace-nowrap px-3 py-5 text-sm text-gray-500">
                                                <div class="ml-4 text-left">
                                                    <div class="font-medium text-gray-900">{{ wo.contracts }} {% if wo.contracts == 1 %}Contract{% else %}Contracts{% endif %}</div>
                                                    <div class="mt-1 text-gray-500"><span class="font-semibold text-gray-900">Expires:</span> {{ wo.expiry|date("m/d/Y") }}</div>
                                                    <div class="mt-1 text-gray-500"><span class="font-semibold text-gray-900">Price:</span> {{ wo.price|number_format(2) }}</div>
                                                    <div class="mt-1 text-gray-500"><span class="font-semibold text-gray-900">Strike:</span> ${{ wo.strike|number_format(2) }}</div>
                                                </div>
                                            </td>
                                            <td class="whitespace-nowrap px-3 py-5 text-sm text-gray-500">
                                                {% if wo.exercised %}
                                                    <span class="inline-flex items-center rounded-md bg-teal-50 px-2 py-1 text-xs font-medium text-teal-700 pill_shadow ring-inset ring-teal-600/[0.20]">Exercised</span>
                                                {% elseif wo.buyout %}
                                                    <span class="inline-flex items-center rounded-md bg-amber-50 px-2 py-1 text-xs font-medium text-amber-700 pill_shadow ring-inset ring-amber-600/[0.20]">Buyout</span>
                                                {% else %}
                                                    <span class="inline-flex items-center rounded-md bg-green-50 px-2 py-1 text-xs font-medium text-green-700 pill_shadow ring-inset ring-green-600/[0.20]">Expired</span>
                                                {% endif %}
                                            </td>
                                            <td class="whitespace-nowrap px-3 py-5 text-sm text-gray-500">
                                                ${{ earned|number_format(2) }}
                                            </td>
                                            <td class="whitespace-nowrap px-3 py-5 text-sm text-gray-500">
                                                <div class="ml-4 text-left">
                                                    {# <div class="font-medium text-gray-900"></div>#}
                                                    <div class="mt-1 text-gray-500">
                                                        <span class="font-semibold text-gray-900">Buy/Expire:</span> <span class="{% if be_diff > 0 %}text-green-700{% else %}text-red-500{% endif %}">{% if be_diff > 0 %}+{% endif %}{{ be_diff|number_format(2) }}</span>
                                                    </div>
                                                    <div class="mt-1 text-gray-500">
                                                        <span class="font-semibold text-gray-900">Strike:</span> <span class="{% if se_diff < 0 %}text-green-700{% else %}text-red-500{% endif %}">{% if se_diff > 0 %}+{% endif %}{{ se_diff|number_format(2) }}</span>
                                                    </div>
                                                </div>
                                            </td>
                                            <td class="whitespace-nowrap px-3 py-5 text-sm text-gray-500">
                                                {% if away_from_target <= 10 %}
                                                    <span class="inline-flex items-center rounded-md bg-red-500 px-2 py-1 text-xs font-medium text-red-900 pill_shadow ring-inset ring-red-900/[0.20]">{{ away_from_target|number_format(2) }}%</span><br />
                                                {% elseif away_from_target > 10 and away_from_target < 20 %}
                                                    <span class="inline-flex items-center rounded-md bg-red-300 px-2 py-1 text-xs font-medium text-red-800 pill_shadow ring-inset ring-red-900/[0.20]">{{ away_from_target|number_format(2) }}%</span><br />
                                                {% elseif away_from_target >= 20 and away_from_target < 30 %}
                                                    <span class="inline-flex items-center rounded-md bg-red-200 px-2 py-1 text-xs font-medium text-red-700 pill_shadow ring-inset ring-red-700/[0.20]">{{ away_from_target|number_format(2) }}%</span><br />
                                                {% elseif away_from_target >= 30 and away_from_target < 40 %}
                                                    <span class="inline-flex items-center rounded-md bg-red-100 px-2 py-1 text-xs font-medium text-red-600 pill_shadow ring-inset ring-red-600/[0.20]">{{ away_from_target|number_format(2) }}%</span><br />
                                                {% elseif away_from_target >= 40 and away_from_target < 50 %}
                                                    <span class="inline-flex items-center rounded-md bg-red-50 px-2 py-1 text-xs font-medium text-red-600 pill_shadow ring-inset ring-red-600/[0.20]">{{ away_from_target|number_format(2) }}%</span><br />
                                                {% elseif away_from_target >= 50 and away_from_target < 60 %}
                                                    <span class="inline-flex items-center rounded-md bg-green-50 px-2 py-1 text-xs font-medium text-green-600 pill_shadow ring-inset ring-green-600/[0.20]">{{ away_from_target|number_format(2) }}%</span><br />
                                                {% elseif away_from_target >= 60 and away_from_target < 70 %}
                                                    <span class="inline-flex items-center rounded-md bg-green-100 px-2 py-1 text-xs font-medium text-green-600 pill_shadow ring-inset ring-green-600/[0.20]">{{ away_from_target|number_format(2) }}%</span><br />
                                                {% elseif away_from_target >= 70 and away_from_target < 80 %}
                                                    <span class="inline-flex items-center rounded-md bg-green-200 px-2 py-1 text-xs font-medium text-green-700 pill_shadow ring-inset ring-green-700/[0.20]">{{ away_from_target|number_format(2) }}%</span><br />
                                                {% elseif away_from_target >= 80 and away_from_target < 90 %}
                                                    <span class="inline-flex items-center rounded-md bg-green-300 px-2 py-1 text-xs font-medium text-green-800 pill_shadow ring-inset ring-green-900/[0.20]">{{ away_from_target|number_format(2) }}%</span><br />
                                                {% elseif away_from_target >= 90 and away_from_target < 100.01 %}
                                                    <span class="inline-flex items-center rounded-md bg-green-500 px-2 py-1 text-xs font-medium text-green-900 pill_shadow ring-inset ring-green-900/[0.20]">{{ away_from_target|number_format(2) }}%</span><br />
                                                {% elseif away_from_target >= 100.01 and away_from_target < 110 %}
                                                    <span class="inline-flex items-center rounded-md bg-red-50 px-2 py-1 text-xs font-medium text-red-600 pill_shadow ring-inset ring-red-600/[0.20]">{{ away_from_target|number_format(2) }}%</span><br />
                                                {% elseif away_from_target >= 110 and away_from_target < 120 %}
                                                    <span class="inline-flex items-center rounded-md bg-red-100 px-2 py-1 text-xs font-medium text-red-600 pill_shadow ring-inset ring-red-600/[0.20]">{{ away_from_target|number_format(2) }}%</span><br />
                                                {% elseif away_from_target >= 120 and away_from_target < 130 %}
                                                    <span class="inline-flex items-center rounded-md bg-red-200 px-2 py-1 text-xs font-medium text-red-700 pill_shadow ring-inset ring-red-700/[0.20]">{{ away_from_target|number_format(2) }}%</span><br />
                                                {% elseif away_from_target >= 130 and away_from_target < 140 %}
                                                    <span class="inline-flex items-center rounded-md bg-red-300 px-2 py-1 text-xs font-medium text-red-800 pill_shadow ring-inset ring-red-900/[0.20]">{{ away_from_target|number_format(2) }}%</span><br />
                                                {% else %}
                                                    <span class="inline-flex items-center rounded-md bg-red-500 px-2 py-1 text-xs font-medium text-red-900 pill_shadow ring-inset ring-red-900/[0.20]">{{ away_from_target|number_format(2) }}%</span><br />
                                                {% endif %}
                                            </td>
                                            <td class="relative whitespace-nowrap py-5 pl-3 pr-4 text-right text-sm font-medium sm:pr-0">
                                                <div class="ml-4 text-left">
                                                    <div class="mt-1 text-gray-500">
                                                        <span class="font-semibold text-gray-900">Earnings Per Share:</span> {{ eps|number_format(3) }}
                                                    </div>
                                                    <div class="mt-1 text-gray-500">
                                                        <span class="font-semibold text-gray-900">Stock Buy Price:</span> {{ wo.stockBuyPrice }}
                                                    </div>
                                                    <div class="mt-1 text-gray-500">
                                                        <span class="font-semibold text-gray-900">Stock Expiry Price:</span> {{ wo.stockExpiryPrice }}
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    {% endif %}
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <h3 style="text-align: center;">Written Options - Total Earned: ${{ total_earned|number_format(2) }}</h3>

    <style>
        .half{
            display: inline-block;
            width: 50%;
            padding: 10px;
            box-sizing: border-box;
            vertical-align: top;
        }

        .instruct{
            max-width: 438px;
        }

        .green{
            color: green;
        }

        .red {
            color: red;
        }



    /* Tailwind Classes*/
       .pill_shadow{
           --tw-ring-offset-shadow: var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);
           --tw-ring-shadow: var(--tw-ring-inset) 0 0 0 calc(1px + var(--tw-ring-offset-width)) var(--tw-ring-color);
           box-shadow: var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000);
       }

       .table-table > :not([hidden]) ~ :not([hidden]) {
           --tw-divide-opacity: 1;
           border-color: rgb(209 213 219 / var(--tw-divide-opacity));
       }

        .table-body > :not([hidden]) ~ :not([hidden]) {
            --tw-divide-y-reverse: 0;
            border-top-width: calc(1px * calc(1 - var(--tw-divide-y-reverse)));
            border-bottom-width: calc(1px * var(--tw-divide-y-reverse));
        }

        .button-shadow{
            --tw-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --tw-shadow-colored: 0 1px 2px 0 var(--tw-shadow-color);
            box-shadow: var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow);

        }

    </style>
{% endblock %}